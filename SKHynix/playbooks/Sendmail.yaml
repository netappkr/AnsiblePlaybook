---
- name: Collect inode usage from each ONTAP cluster
  hosts: task_server_1
  gather_facts: no
  tasks:
    - name: Search for 'script' in all directories
      find:
        paths: "{{ scripts_dir }}"
        patterns: "generate_table.py"
        recurse: yes
        file_type: file
      register: files_matched

    - name: Print the matched files
      debug:
        msg: "{{ files_matched.files[0].path }}"

    - name: Generate HTML table from inode information using a Python script
      command: "python3 {{ files_matched.files[0].path }} -r clusters_inode_info -f /tmp/clusters_inode_info.json"
      register: html_tables

    - name: Send inode usage report via email
      mail:
        host: "{{ smtp_server }}"
        port: "{{ smtp_port }}"
        username: "{{ smtp_username }}"
        password: "{{ smtp_password }}"
        to: "{{ email_to }}"
        subject: "ONTAP Cluster Inode Usage Report"
        body: "{{ html_tables.stdout }}"
        from: "{{ email_from }}"
        secure: naver
        subtype: html
        headers: 
        - Content-Type="text/html"
      when: html_tables.stdout is defined
